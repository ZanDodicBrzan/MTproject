<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Aljaz test </title>
</head>

<style>
body {
  font-family: "Helvetica Neue", Helvetica, sans-serif;
  font-size: 14px;
  color: #333;
}

#content .info {
  height: 20px;
}

#content .map path {
  fill: #5a5b56;
  stroke: #fff;
}

#izpis{
  position: relative;
}

#div-obcina{
  position: absolute;
}
#div-skupaj{
  position: absolute;
  left: 500px;
}
#div-date_select{
  position: absolute;
  top: 400px;
  z-index: 1;
}
#div-map{
  position: relative;
  top: 300px;
}

</style>

<body>
  <div id="content">
    <div id="izpis">
    <h1><div class="info">Poglej po občinah!</div></h1>
    <div id="div-obcina">
      <h2>Trenutna občina:</h2>
      <h2><div class="obcina">Nič</div></h2>
      <h4>Aktivni Primeri</h4><h4 id="active">0</h4>
      <h4>Potrjeni Primeri</h4><h4 id="confirmed">0</h4>
      <h4>Umrli</h4><h4 id="deaths">0</h4>
    </div>
    <div id="div-skupaj">
      <h2>Št. opravljenih testov: </h2><h2 id="selected-date"></h2>
      <h4>Št. pozitivnih testov:</h4><h4 id="active-on-date">0</h4>
      <h4>Potrjeni Primeri</h4><h4 id="confirmed-on-date">0</h4>
      <h4>Umrli</h4><h4 id="deaths-on-date">0</h4>
    </div>

    <div id="div-date_select">
      <input type="date" id="date"></input>
      <input type="range"></input>
    </div>
    </div>
    <!-- Tukaj tipo daš nek place holder kjer bo mapa -->
    <div id="div-map">
      <svg id="placeH" width="1000px" height="700px">
        <g class="map"></g>
      </svg>
    </div>
    
    <!-- ta svg zgoraj -->
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.9.1/d3.min.js"></script>
  <script type="text/javascript" src="data.json"></script>
<script>
//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------

let api = "https://api.sledilnik.org/api/municipalities?from=2020-10-10&to=2020-10-14";

let from = "2020-10-10";
let to = "2020-10-10";

let datum = document.getElementById("date");

datum.addEventListener("change" , (event) =>{
  document.getElementById("selected-date").innerHTML = datum.value;
  let stats = getData(`https://api.sledilnik.org/api/Stats?from=${from}&to=${to}`);
  
  document.getElementById("active-on-date").innerHTML = stats.performedTests;
  document.getElementById("confirmed-on-date").innerHTML = stats.positiveTests;
  //if(podatki.deceasedToDate==undefined) document.getElementById("deaths-on-date").innerHTML = "0";
  //else document.getElementById("deaths-on-date").innerHTML = podatki.deceasedToDate;

});


//---------------------------------------------------------------------------------------------------------------------------------------------------------------------------

var projection = d3.geoMercator()
  .scale(13000)
  .translate([200, 280])
  .center([14, 46.3]);

var geoGenerator = d3.geoPath()
  .projection(projection);


// ko daš miško čez
function handleMouseover(d) {
  d3.select('#content .obcina')
    .text(d.properties.name);

  let obcina = (d.properties.name).replace(/\s+/g, '_').toLowerCase();
  obcineFromTo(from, to, obcina);

  d3.select(this)
    .transition()
    .duration('50')
    .attr('opacity', '.60')
    //.style("stroke", "black"); obroba ne dela for some reason xddd
}


// ko daš miško dol
function handleMouseout(d) {
  d3.select('#content .obcina')
    .text("Nič");

  d3.select(this)
    .transition()
    .duration('50')
    .attr('opacity', '1')
    //.style("stroke", "white");
}

// ko klikneš ni še dopolnjeno tu damo statse in to nekam prikažemo in to
function onClick(d) {
    d3.select(this)
    .transition()
    .duration('50')
    .style("fill", "#e35d6a");
}

// update live 
function update(geojson) {
  var u = d3.select('#content g.map')
    .selectAll('path')
    .data(geojson.features);

  u.enter()
    .append('path')
    .attr('d', geoGenerator)
    .on('mouseover', handleMouseover)
    .on('mouseout', handleMouseout)
    .on("click", onClick)
}


// podatki map ----------------------------------------------------------
d3.json('data/svn_regional.geojson', function(err, json) {
  update(json)
})

//const from = _id("from").value;
//const to =  _id("to").value;
//const from = "2020-10-10";
//const to = "2020-10-10";

// funkcija za pridobivanje podatkov
async function getData(url) {
  return fetch(url)
  .then(res => {
          if (!res.ok) {
              throw new Error(res.error);
          }
          return res;
   })
  .then(res => res.json())
  .catch(err => console.log(err));
}



const obcineFromTo = async(from, to, obcina) => {
  from = document.getElementById("date").value;
  to = document.getElementById("date").value;
  console.log(from);

  let podatkiObcinZaEnMesec = await getData(`https://api.sledilnik.org/api/municipalities?from=${from}&to=${to}`);
  Object.keys(podatkiObcinZaEnMesec).forEach(dan => {
      const arrayRegij = Object.values(podatkiObcinZaEnMesec[dan].regions); // array regij
      
      arrayRegij.forEach(regija => {
          Object.entries(regija).forEach(([imeObcine, podatki]) => {
            if(imeObcine == obcina){
              //console.log(podatki);
              document.getElementById("active").innerHTML = podatki.activeCases;
              document.getElementById("confirmed").innerHTML = podatki.confirmedToDate;
              if(podatki.deceasedToDate==undefined) document.getElementById("deaths").innerHTML = "0";
              else document.getElementById("deaths").innerHTML = podatki.deceasedToDate;
              //console.log(regija);
              
              



            }
          })
      })
  })
};
</script>
</body>
</html>