<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Kung Flu Tracker</title>
</head>

<style>
body {
  font-family: "Helvetica Neue", Helvetica, sans-serif;
  font-size: 14px;
  color: #333;
}

#content .info {
  height: 20px;
}

#content .map path {
  fill: #5a5b56;
  stroke: #fff;
}

</style>

<body>
  <div id="content">
    <h1><div class="info">Poglej po občinah!</div></h1>

    <form id="form">
        <input type="date" name="from" id="from" />
        <!-- <input type="date" name="to" id="to" /> -->
        <input type="submit" />
    </form>
    <div id="results">

    </div>

    <h2>Trenutno hoverana:</h2>
    <h2><div class="obcina">Nič</div></h2>
    <!-- Tukaj tipo daš nek place holder kjer bo mapa -->
    <svg id="placeH" width="1000px" height="700px">
      <g class="map"></g>
    </svg>
    <!-- ta svg zgoraj -->
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.9.1/d3.min.js"></script>
<script>

// naredu funkcijo, da ni treba pol vedno dat document.getElementById ce se hoce kj pisat, sam shorthand npr: _id("results")
const _id = (id) => document.getElementById(id);

// funk. za pridobivanje podatkov
async function getData(url) {
  return fetch(url)
  .then(res => {
          if (!res.ok) {
              throw new Error(res.error);
          }
          return res;
   })
  .then(res => res.json())
  .catch(err => console.log(err));
}

const obcineFromTo = async(from, to) => {
    let podatkiObcinZaEnMesec = await getData(`https://api.sledilnik.org/api/municipalities?from=${from}&to=${to}`);
    Object.keys(podatkiObcinZaEnMesec).forEach(dan => {
        const arrayRegij = Object.values(podatkiObcinZaEnMesec[dan].regions); // array regij
        arrayRegij.forEach(regija => {
            Object.entries(regija).forEach(([imeObcine, podatki]) => izpisPodatkov(imeObcine, podatki))
        })
    })
};

function izpisPodatkov(imeObcine, podatki) {
    _id("results").insertAdjacentHTML('beforeend', `<div classname='obcina'>
        <b>${imeObcine}:</b>
        <ul>
            <li>Aktivne okužbe: ${podatki.activeCases}</li>
            <li>Vsi potrjeni do datuma: ${podatki.confirmedToDate}</li>
            <li>Št. umrlih do datuma: ${podatki.deceasedToDate}</li>
        </ul>
        </div>`)
};

const submit = (e) => {
    e.preventDefault();
    const from = _id("from").value;
    //const to = _id("to").value;
    obcineFromTo(from,from);
}
_id("form").onsubmit=submit;


var projection = d3.geoMercator()
  .scale(13000)
  .translate([200, 280])
  .center([14, 46.3]);

var geoGenerator = d3.geoPath()
  .projection(projection);


// ko daš miško čez
function handleMouseover(d) {
  d3.select('#content .obcina')
    .text(d.properties.name);

  d3.select(this)
    .transition()
    .duration('50')
    .attr('opacity', '.60')
    //.style("stroke", "black"); obroba ne dela for some reason xddd
}

// ko daš miško dol
function handleMouseout(d) {
  d3.select('#content .obcina')
    .text("Nič");

  d3.select(this)
    .transition()
    .duration('50')
    .attr('opacity', '1')
    //.style("stroke", "white");
}

// ko klikneš ni še dopolnjeno tu damo statse in to nekam prikažemo in to
function onClick(d) {
    d3.select(this)
    .transition()
    .duration('50')
    .style("fill", "#e35d6a");
}

// update live 
function update(geojson) {
  var u = d3.select('#content g.map')
    .selectAll('path')
    .data(geojson.features);

  u.enter()
    .append('path')
    .attr('d', geoGenerator)
    .on('mouseover', handleMouseover)
    .on('mouseout', handleMouseout)
    .on("click", onClick)
}



// REQUEST DATA
d3.json('data/svn_regional.geojson', function(err, json) {
  update(json)
})

  </script>
</body>
</html>